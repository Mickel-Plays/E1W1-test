<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E1W1 Conversion Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  #map { height: 300px; border-radius: 12px; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-4">
<div class="max-w-7xl mx-auto">

  <h1 class="text-4xl font-bold text-gray-800 text-center mb-6">üôè E1W1 Conversion Tracker</h1>

  <!-- Dashboard -->
  <div id="dashboard" class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4">üìä Dashboard</h2>
    <p><strong>Total Lives Reached:</strong> <span id="totalReached">0</span></p>
    <p><strong>Total Lives Saved:</strong> <span id="totalSaved">0</span></p>
    <p><strong>Top Region:</strong> <span id="topRegion">N/A</span></p>
    <p><strong>Active Regions:</strong> <span id="activeRegions">N/A</span></p>
    <canvas id="methodChart" class="mt-4"></canvas>
  </div>

  <!-- Form & Map -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold mb-4">üìù Record New Conversion</h2>
      <form id="conversionForm" class="space-y-4">
        <div>
          <label class="block mb-1">Lives Reached</label>
          <input type="number" id="livesReached" min="0" value="0" class="w-full border rounded p-2"/>
        </div>
        <div>
          <label class="block mb-1">Lives Saved</label>
          <input type="number" id="livesSaved" min="0" value="0" class="w-full border rounded p-2"/>
        </div>
        <div>
          <label class="block mb-1">Region</label>
          <select id="region" required class="w-full border rounded p-2">
            <option value="">Select Region</option>
            <option value="Region 1 - Barima-Waini">Region 1 - Barima-Waini</option>
            <option value="Region 2 - Pomeroon-Supenaam">Region 2 - Pomeroon-Supenaam</option>
            <option value="Region 3 - Essequibo Islands-West Demerara">Region 3 - Essequibo Islands-West Demerara</option>
            <option value="Region 4 - Demerara-Mahaica">Region 4 - Demerara-Mahaica</option>
            <option value="Region 5 - Mahaica-Berbice">Region 5 - Mahaica-Berbice</option>
            <option value="Region 6 - East Berbice-Corentyne">Region 6 - East Berbice-Corentyne</option>
            <option value="Region 7 - Cuyuni-Mazaruni">Region 7 - Cuyuni-Mazaruni</option>
            <option value="Region 8 - Potaro-Siparuni">Region 8 - Potaro-Siparuni</option>
            <option value="Region 9 - Upper Takutu-Upper Essequibo">Region 9 - Upper Takutu-Upper Essequibo</option>
            <option value="Region 10 - Upper Demerara-Berbice">Region 10 - Upper Demerara-Berbice</option>
          </select>
        </div>
        <div>
          <label class="block mb-1">Method</label>
          <select id="method" required class="w-full border rounded p-2">
            <option value="">Select Method</option>
            <option value="Door-to-Door">Door-to-Door</option>
            <option value="Church Service">Church Service</option>
            <option value="Street Preaching">Street Preaching</option>
            <option value="Bible Study">Bible Study</option>
            <option value="Community Event">Community Event</option>
            <option value="Personal Testimony">Personal Testimony</option>
            <option value="Online Ministry">Online Ministry</option>
          </select>
        </div>
        <div>
          <label class="block mb-1">Notes</label>
          <textarea id="notes" rows="3" class="w-full border rounded p-2"></textarea>
        </div>
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">‚úùÔ∏è Record Conversion</button>
      </form>
    </div>

    <!-- Map -->
    <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold mb-4">üó∫Ô∏è Guyana Conversion Map</h2>
      <div id="map"></div>
    </div>
  </div>

  <!-- Recent Conversions -->
  <div id="recentConversions" class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-4">üìã Recent Conversions</h2>
    <div id="recentList" class="space-y-3 text-gray-600">No conversions yet. üôè</div>
  </div>

</div>

<script>
  const GOOGLE_SHEET_URL = "YOUR_PUBLISHED_CSV_URL_HERE"; // CSV published from Google Sheets
  const GOOGLE_SCRIPT_URL = "YOUR_DEPLOYED_WEB_APP_URL_HERE"; // Web app URL for POST

  let conversions = [];

  // Map setup
  const map = L.map('map').setView([4.8604, -58.9302], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  const regionCoords = {
    "Region 1 - Barima-Waini": [8.2, -59.7833],
    "Region 2 - Pomeroon-Supenaam": [7.2644, -58.5076],
    "Region 3 - Essequibo Islands-West Demerara": [6.805, -58.4333],
    "Region 4 - Demerara-Mahaica": [6.8013, -58.1551],
    "Region 5 - Mahaica-Berbice": [6.2766, -57.356],
    "Region 6 - East Berbice-Corentyne": [6.2472, -57.517],
    "Region 7 - Cuyuni-Mazaruni": [6.4074, -58.6218],
    "Region 8 - Potaro-Siparuni": [5.2667, -59.15],
    "Region 9 - Upper Takutu-Upper Essequibo": [3.3833, -59.8],
    "Region 10 - Upper Demerara-Berbice": [5.9879, -58.2708]
  };

  function addMarker(conv){
    if(regionCoords[conv.region]){
      L.marker(regionCoords[conv.region])
       .addTo(map)
       .bindPopup(`<b>${conv.region}</b><br>${conv.method}<br>Reached: ${conv.reached}<br>Saved: ${conv.saved}`);
    }
  }

  function updateDashboard(){
    const totalReached = conversions.reduce((sum,c)=>sum+parseInt(c.reached),0);
    const totalSaved = conversions.reduce((sum,c)=>sum+parseInt(c.saved),0);
    document.getElementById("totalReached").textContent = totalReached;
    document.getElementById("totalSaved").textContent = totalSaved;

    // Active regions
    const activeRegions = [...new Set(conversions.map(c=>c.region))];
    document.getElementById("activeRegions").textContent = activeRegions.join(", ") || "N/A";

    // Top region
    const regionCount = {};
    conversions.forEach(c=>regionCount[c.region]=(regionCount[c.region]||0)+1);
    const topRegion = Object.entries(regionCount).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById("topRegion").textContent = topRegion ? topRegion[0] : "N/A";

    // Method chart
    const methodCount = {};
    conversions.forEach(c=>methodCount[c.method]=(methodCount[c.method]||0)+1);
    const ctx = document.getElementById("methodChart").getContext("2d");
    if(window.methodChart) window.methodChart.destroy();
    window.methodChart = new Chart(ctx,{
      type:"pie",
      data:{
        labels:Object.keys(methodCount),
        datasets:[{data:Object.values(methodCount), backgroundColor:["#007bff","#28a745","#ffc107","#dc3545","#6f42c1","#20c997","#fd7e14"]}]
      }
    });
  }

  function updateRecentConversions(){
    const recent = conversions.slice(-5).reverse();
    const container = document.getElementById("recentList");
    if(recent.length===0) container.innerHTML="No conversions yet. üôè";
    else container.innerHTML = recent.map(c=>`<div class="bg-gray-50 rounded-lg p-3 border-l-4 border-green-500">
      <p>${c.region} ‚Ä¢ ${c.method}</p>
      <p>Reached: ${c.reached} | Saved: ${c.saved}</p>
    </div>`).join("");
  }

  // Load conversions from Google Sheet CSV
  async function loadConversions(){
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6vMFmx794LToNd-oEWFJ9kG4Ez-7fUeGiL0qrHp5Mq-lGYMm3OwyiiIQeFLWvlfyxehbdpbl333gK/pub?output=csv");
    const csv = await res.text();
    conversions = csv.split("\n").slice(1).filter(r=>r).map(r=>{
      const [timestamp, region, method, reached, saved, notes] = r.split(",");
      return {timestamp, region, method, reached, saved, notes};
    });
    conversions.forEach(addMarker);
    updateDashboard();
    updateRecentConversions();
  }

  loadConversions();

  // Submit conversion
  document.getElementById("conversionForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const conv = {
      timestamp: new Date().toISOString(),
      region: document.getElementById("region").value,
      method: document.getElementById("method").value,
      reached: document.getElementById("livesReached").value,
      saved: document.getElementById("livesSaved").value,
      notes: document.getElementById("notes").value
    };
    // POST to Google Apps Script Web App
    await fetch("https://script.google.com/macros/s/AKfycbwRAImKKeNVUevbgXR1nlb4LCsT6E7hf6TXe0akA-KGEi8o7xwKqToZp_xv8kgdg1LN/exec",{
      method:"POST",
      body: JSON.stringify(conv),
      headers: {"Content-Type":"application/json"}
    });
    // Reload after submission
    setTimeout(loadConversions, 1000);
    e.target.reset();
  });
</script>
</body>
</html>
